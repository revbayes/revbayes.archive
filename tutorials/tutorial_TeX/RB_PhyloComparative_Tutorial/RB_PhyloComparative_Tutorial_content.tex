\section{Introduction}

The subject of the comparative method is the analysis of trait evolution at the macroevolutionary scale.
In a comparative context, many different questions can be addressed: tempo and mode of evolution, correlated evolution of multiple quantitative traits, trends and bursts, changes in evolutionary mode correlated with major key innovations in some groups, etc \citep[see][for a good introduction]{Harvey:1991p899}.

In order to correctly formalize comparative questions, the underlying phylogeny should always be explicitly accounted for. This point is clearly illustrated, in particular, by the independent contrast method \citep{Felsenstein:1985p686}. Practically speaking, the phylogeny and the divergence times are usually first estimated using a separate phylogenetic reconstruction software. In a second step, this time-calibrated phylogeny is used as an input to the comparative method.
Doing this, however, raises a certain number of methodological problems:
\begin{itemize}
\item
the uncertainty about the phylogeny (and about divergence times) is ignored
\item
the traits themselves may have something to say about the phylogeny
\item
the rate of substitution, and more generally the parameters of the substitution process, can also be seen as quantitative traits, amenable to a comparative analysis.
\end{itemize}
All these points are not easily formalized in the context of the step-wise approach mentioned above.
Instead, what all this suggests is that phylogenetic reconstruction, molecular dating and the comparative method should all be considered jointly, in the context of one single overarching probabilistic model.

Thanks to its modular structure, RevBayes represents a natural framework for attempting this integration.
The aim of the present tutorial is to guide you through a series of examples where this integration is achieved, step by step.
It can also be considered as an example of the more general perspective of \emph{integrative modeling}, which can be recruited in many other contexts.

\section{Data and files}

In the \cl{data} folder, you will find the following files
\begin{itemize}
\item
\cl{plac40lhtlog.nex}: 3 life-history traits (age at sexual maturity, body mass, maximum recorded lifespan) for 40 placental mammals \citep[taken from the Anage database,][]{deMagalhaes:2009p991}. The traits have been log-transformed.
\item
\cl{plac40\_4fold.nex}: an alignment made of a concatenation of 17 nuclear genes in 40 placental mammals \citep[from][]{Lartillot:2012be}, with only the four-fold degenerate third coding positions.
\item
\cl{chronoplac40.tree}: a time-calibrated phylogeny, which has been obtained by running another software program \citep[PhyloBayes,][]{Lartillot:2009p884}.
On the cluster, and if you are logged under an X-terminal, you can visualize this tree using the \cl{njplot} command:
\\
\cl{njplot chronoplac40.tree}
\item
\cl{archaeaRNA.nex}: an alignment of rRNA sequences of 33 archaeal species.
\item
\cl{archaeaTemp.nex}: optimal growth temperatures for the 33 archaeal species.
\end{itemize}

\section{Univariate Brownian evolution of quantitative traits}

\label{univariate}

As a first preliminary exercise, we wish to reconstruct the evolution of body mass in placental mammals and, in particular, estimate the body mass of their last common ancestor.
For this, we will assume that the logarithm of body mass follows a simple univariate Brownian motion along the phylogeny.
In a first step, we will ignore phylogenetic uncertainty:
thus, we will assume that the Brownian process describing body mass evolution runs along a fixed time-calibrated phylogeny (with fixed divergence times), such as specified in the file \cl{chronoplac40.tree}.

You may want to take the time to visualize the tree given in \cl{chronoplac40.tree} as well as the matrix of quantitative traits specified by the \cl{plac40lhtlog.nex} file, before going into the modeling work described below.

\subsection{The model and the priors}

A univariate Brownian motion $x(t)$ is parameterized by its starting value at the root of the phylogeny $x(0)$ and a rate parameter $\sigma$. This rate parameter tunes the amplitude of the variation per unit of time. Specifically, along a given time interval $(0,T)$, the value of $X$ at time $T$ is normally distributed, with mean $x(0)$ and variance $\sigma^2 T$:
\begin{eqnarray*}
x(T) &\sim& \text{Normal} \left( x(0), \sigma^2 T \right).
\end{eqnarray*}

Concerning $\sigma$, we can formalize the idea that we are ignorant about the \emph{scale} (the order of magnitude) of this parameter by using a log-uniform prior:
\begin{eqnarray*}
\sigma &\sim& \frac{1}{\sigma}.
\end{eqnarray*}

Concerning the initial value $x(0)$ of the Brownian process at the root of the phylogeny,
the current version of RevBayes only implements a uniform prior.
This is done by default (no need to explicitly define it).

Finally, the tree topology $\psi$ is, as mentioned above, fixed to some externally given phylogeny.
The entire model is now specified: tree $\psi$, variance $\sigma$ and Brownian process $x(t)$:
\begin{eqnarray*}
\sigma &\sim& \frac{1}{\sigma},
\\
x(0) &\sim& \text{Uniform},
\\
x(t) \mid \Psi, \sigma &\sim& \text{Brownian} \left( x(0), \, \psi, \, \sigma \right).
\end{eqnarray*}
Conditioning the model on empirical data by clamping $x(t)$ at the tips of the phylogeny, we can then run a MCMC to sample from the joint posterior distribution on $\sigma$ and $x$. Once this is done, we can obtain posterior means, medians or credible intervals for the value of body mass or other life-history traits for specific ancestors.


\subsection{Programming the model in RevBayes}

In \cl{tutorials/NESCent/RevBayes\_scripts/}, you will find a script called \cl{placentaliaMass.Rev}.
This script implements the univariate Brownian model described above. Instead of re-typing the content of script entirely in the context of an interactive \cl{RevBayes} session, you can instead run the script directly, by first going to the \cl{tutorials/NESCent/} folder and then giving the script as an argument to the \cl{RevBayes} program:
\\
\cl{RevBayes RevBayes\_scripts/placentaliaMass.Rev}.

This script essentially reformulates what has been explained in the last subsection, now in the Rev language:
\begin{itemize}
\item
load trait data:
\\
\cl{contData <- readCharacterData("data/plac40lhtlog.nex")}
\item
load the time-tree from file:
\\
\cl{treeArray <- readTrees("data/chronoplac40.tree"
\\
psi <- treeArray[1]
}
\item
define $\sigma$, with a truncated log-uniform prior:
\\
\cl{sigma $\sim$ \text{dnLogUniform}(min=0.001,max=1000)}
\\
to accelerate convergence, it can be useful to force initialization of $\sigma$ to a small value:
\\
\cl{sigma.setValue(0.1)}
\item
define the multivariate Brownian process, which we will call \cl{logmass}:
\\
\cl{logmass $\sim$ dnBrownian(psi,sigma)}
\item
condition the Brownian model on empirically observed values for body mass in extant taxa.
Here, we need to specify that body mass is the second column of the dataset:
\\
\cl{
logmass.clampAt(contData,2)
}
\end{itemize}
The model is now entirely specified. We can define the moves on its parameters:
\begin{itemize}
\item
initialize a running index for storing moves:
\\
\cl{index <- 1}
\item
push a scaling move on $\sigma$:
\\
\cl{
moves[index] <- mvScale(sigma, lambda=2.0, tune=true, weight=3.0)
\\
index <- index + 1
}
\item
a sliding move on the Brownian process
\\
\cl{
moves[index] <- mvRealNodeValTreeSliding(process=logmass, lambda=10, tune=true, weight=100)
\\
index <- index + 1
}
\item
a global translation move on the Brownian process:
\\
\cl{
moves[index] <- mvRealNodeValTreeTranslation(process=logmass,lambda=1,
\\
tune=true,weight=1)
\\
index <- index + 1
}
\item
before creating the model, we define summary statistics, to be monitored during the MCMC: the mean and the standard deviation of the trait across the tree:
\\
\cl{
meanlogmass := logmass.mean()
\\
stdevlogmass := logmass.stdev()
}
\item
as well as the value of the log of body mass for the root:
\\
\cl{
rootlogmass := logmass.rootVal()
}
\item
now, create the model
\\
\cl{
mymodel <- model(sigma)
}
\item
make a screen monitor that tracks the summary statistics of interest:
\\
\cl{
monitors[1] <- mnScreen(printgen=10, sigma, rootlogmass, meanlogmass, stdevlogmass)
}
\item
a file monitor that does the same thing, but directly into a file:
\\
\cl{
monitors[2] <- mnFile(filename="output/placmass.trace", printgen=10, separator = "       ", sigma, rootlogmass, meanlogmass, stdevlogmass)
}
\item
a file monitor for the ancestral reconstruction of traits along the entire tree (in newick format):
\\
\cl{
monitors[3] <- mnFile(filename="output/placmass.logmass", printgen=10, separator = "       ", logmass)
}
\item
and a general model monitor:
\\
\cl{
monitors[4] <- mnModel(filename="output/placmass.log", printgen=10, separator = " ")
}
\end{itemize}
We can finally create a mcmc, and run it for a good 100 000 cycles:
\\
\cl{
mymcmc <- mcmc(mymodel, monitors, moves)
\\
mymcmc.burnin(generations=100,tuningInterval=100)
\\
mymcmc.run(100000)
}

\subsection*{Exercises}

\begin{itemize}
\item
run the model, check convergence and obtain a sample from the posterior distribution
\item
using \cl{Tracer}, visualize the posterior distribution on ancestral placental body mass
\item
calculate the 95\% credible interval for ancestral body mass
\item
calculate the 95\% credible interval for the rate of evolution of the log of body mass ($\sigma$)
\end{itemize}



\section{Correlated evolution of multiple traits}
\label{multivariate}

Next, we would like to estimate the correlation between the $K=3$ life-history traits given in the \cl{plac40lhtlog.nex} file, while properly taking into account phylogenetic inertia. 
To do so, we will assume that the traits jointly evolve along the phylogeny as a \emph{multivariate} Brownian process.
We will estimate the \emph{covariance matrix} of this process and assess the empirical support in favor of positive or negative correlations between pairs of traits in terms of posterior probabilities of having positive or negative entries in this covariance matrix.
At this stage of the tutorial, we will again ignore phylogenetic uncertainty.

\subsection{The model and the priors}

A multivariate Brownian process $X(t)$, of dimension $K$ (here $K=3$),
is entirely parameterized by its starting value ($X(0)$ at the root of the phylogeny, which a vector of dimension $K$) and a $K \times K$ symmetric positive matrix (the covariance matrix), which we will call $\Sigma$.
A positive entry between two traits, say $\Sigma_{12} > 0$, means that when trait 1 increases, trait 2 also tends to increase. Conversely, a negative entry means that the two traits tend to undergo variation in opposite directions.
As for the diagonal entries (e.g. $\Sigma_{11}$), they represent the variance per unit of time (i.e. the rate of evolution) of each trait considered marginally,
thus very much like $\sigma^2$ (\emph{not} $\sigma$) in the univariate model of the previous section.

On $\Sigma$, we will assume an inverse-Wishart prior:
\begin{eqnarray*}
\Sigma &\sim& W^{-1}(\Sigma_0, d),
\end{eqnarray*}
where $\Sigma_0$ is a multiple of the identity matrix (i.e. $\Sigma_0 = \kappa I_K$), for some positive real number $\kappa$.
Using a prior centered on a diagonal matrix means that we want to be indifferent with respect to either positive or negative correlations among traits. As for the parameter $\kappa$, it will set the amplitude of the variation per unit of time of the traits. Since we have no idea about the scale of this parameter, we can use a log-uniform prior:
\begin{eqnarray*}
\kappa &\sim& \frac{1}{\kappa}.
\end{eqnarray*}
This completes our model:
\begin{eqnarray*}
\kappa &\sim& \frac{1}{\kappa},
\\
\Sigma \mid \kappa &\sim& W^{-1}(\Sigma_0 = \kappa I_K , \, d = K+2),
\\
X(0) &\sim& \text{Uniform},
\\
X(t) \mid X(0), \Psi, \Sigma &\sim& \text{Brownian}(X(0), \, \psi, \, \Sigma).
\end{eqnarray*}
As in the univariate case, we can then clamp $X$ at the tips of the phylogeny and sample from the joint distribution over the parameters of the model by MCMC.
Once this is done, we can estimate marginal posterior probabilities (e.g. for positive or negative covariance among traits) and infer ancestral traits.

\subsection*{Programming the model in RevBayes}

You may find it convenient to program this multivariate model by first duplicating the script of the univariate model:
\\
\cl{cp placentaliaMass.Rev placentaliaTraits.Rev}
\\
Then, you can edit the new script, \cl{placentaliaTraits.Rev}, and introduce the modifications that would change the univariate model
into its multivariate counterpart.

In the following, only those aspects of the multivariate model that differ from the univariate case are outlined.
Essentially, instead of a univariate Brownian motion parameterized by a scalar parameter, you now need to:
\begin{itemize}
\item
define $\kappa$:
\\
\cl{kappa $\sim$ \text{dnLogUniform}(min=0.001,max=1000)}
\item
define the number of degrees of freedom as $d = K+2$:
\\
\cl{df <- nTraits+2}
\item
define the covariance matrix $\Sigma$ as inverse Wishart:
\\
\cl{Sigma $\sim$ dnInvWishart(dim=nTraits, kappa=kappa, df=df)}
\item
define the multivariate Brownian process:
\\
\cl{X $\sim$ dnBrownianMultiVariate(psi,Sigma)}
\item
condition the Brownian model on quantitative trait data.
This needs to be done separately for each trait:
\\
\cl{
for (i in 1:nTraits)    \{
        X.clampAt(contData,i,i)
\}
}
\\
Here, we give twice the index \cl{i} to the \cl{clampAt} function: the first corresponds to the entry of the Brownian process, and the second one to the column of the data matrix. In some cases (as we will see below), the Brownian process and the data matrix may not be of same dimension, and therefore, it will be useful to be able to specify arbitrary maps between them.
\end{itemize}
The model is now entirely specified. We can define the moves on its parameters.
\begin{itemize}
\item
initialize a running index for storing moves:
\\
\cl{index <- 1}
\item
push a scaling move on $\kappa$:
\\
\cl{
moves[index] <- mvScale(kappa, lambda=2.0, tune=true, weight=3.0)
\\
index <- index + 1
}
\item
a sliding move on the Brownian process
\\
\cl{
moves[index] <- mvMultivariateRealNodeValTreeSliding(process=X, lambda=10,
\\
tune=true,weight=100)
\\
index <- index + 1
}
\item
a global translation move on the Brownian process (component-wise, that is, a random global translation across the entire phylogeny is applied to one trait taken at random):
\\
\cl{
moves[index] <- mvMultivariateRealNodeValTreeTranslation(process=X, lambda=1,
\\
tune=true, weight=1)
\\
index <- index + 1
}
\item
finally, a conjugate Gibbs move for $\Sigma$: as it turns out, conditional on $\kappa$ and the Brownian process $X$, it is possible to directly resample $\Sigma$ from its conditional posterior distribution \citep{Lartillot:2011p55}. In RevBayes, this is implemented as follows:
\\
\cl{
moves[index] <- mvConjugateInverseWishartBrownian(sigma=Sigma, process=X,
\\
kappa=kappa, df=df, weight=1)
\\
index <- index + 1
}
\end{itemize}
Before creating the model, we need to define a few summary statistics, which we want to track during MCMC, either to monitor convergence or for obtaining interesting outputs.
First, suppose you are specifically interested in the covariance and the correlation coefficient associated with the joint variation of body-size (trait 2) and longevity (trait 3). You may also be interested in the \emph{partial} correlation coefficient between body mass and longevity, i.e. while controlling for variation in age at sexual maturity. These three quantities can be singled out and named as follows:
\begin{itemize}
\item
the covariance:
\\
\cl{
cov23 := Sigma.covariance(2,3)
}
\item
the correlation coefficient:
\\
\cl{
cor23 := Sigma.correlation(2,3)
}
\item
the variance per unit of time of, say, log body mass, which is given by the diagonal entry:
\\
\cl{
var2 := Sigma.covariance(2,2)
}
\item
we can also get all correlation coefficients into a single vector (you can skip this part during the session and leave it as  homework):
\begin{verbatim}
# initialize a running index
corrindex <- 1
# loop over all pairs of traits
for (i in 1:(nTraits-1))    {
    for (j in (i+1):nTraits) {
        correl[corrindex] := Sigma.correlation(i,j)
        corrindex <- corrindex + 1
    }
}
\end{verbatim}
\item
we could be interested in tracking several summary statistics also for the Brownian motion, in particular the mean along the tree, separately for each trait:
\begin{verbatim}
for (i in 1:nTraits)    {
        meanX[i] := X.mean(i)
}
\end{verbatim}
\end{itemize}
After creating the model, all these new variables (\cl{cor12}, \cl{correl}, \cl{meanX}, etc) can be monitored, along with the other parameters of the model:
\begin{itemize}
\item
create the model
\\
\cl{
mymodel <- model(kappa)
}
\item
make a screen monitor that tracks correlation coefficients and mean Brownian values:
\\
\cl{
monitors[1] <- mnScreen(printgen=10, correl, meanX)
}
\item
a file monitor that does the same thing, but directly into a file:
\\
\cl{
monitors[2] <- mnFile(filename="output/plactraits.trace", printgen=10, separator = "       ", correl, meanX)
}
\item
a file monitor for $\Sigma$:
\\
\cl{
monitors[3] <- mnFile(filename="output/plactraits.cov", printgen=10, separator = "  ", Sigma)
}
\item
a file monitor for the ancestral reconstruction of traits:
\\
\cl{
monitors[4] <- mnFile(filename="output/plactraits.traits", printgen=10, separator = "       ", X)
}
\item
and a general model monitor:
\\
\cl{
monitors[5] <- mnModel(filename="output/plactraits.log", printgen=10, separator = " ")
}
\end{itemize}
We can finally create the mcmc and run it:
\\
\cl{
mymcmc <- mcmc(mymodel, monitors, moves)
\\
mymcmc.burnin(generations=100,tuningInterval=100)
\\
mymcmc.run(100000)
}

\subsection*{Exercises}

\begin{itemize}
\item
using \cl{Tracer}, visualize the posterior distribution on the correlation coefficient between mass and longevity.
\item
estimate the posterior mean, median and 95\% credible interval for this correlation coefficient.
\item
does the credible inrerval overlap 0? What does that say about the empirical support for the correlation between body mass and longevity?
\item
what proportion of the variation in longevity among placental mammals is explained by body mass?
\end{itemize}


\section{Accounting for uncertainty in divergence times}

Starting from the model implemented in the last section, we now want to account for phylogenetic uncertainty. As first pointed out by \cite{Huelsenbeck:2003p999}, this can easily be done in a Bayesian framework, through the use of a joint model combining sequence data and quantitative traits. Specifically:
\begin{itemize}
\item
two data sets are loaded: one for sequence data and one for quantitative traits
\item
a tree is defined (here, with a uniform prior, but this could be a birth death or anything else)
\item
a Brownian model is defined over the tree (just as described in the previous section)
\item
the Brownian model is conditioned on the quantitative trait data
\item
a substitution model is defined over the same tree
\item
the substitution model is conditioned on the molecular sequence data.
\end{itemize}
Instead of remaining fixed to a pre-defined value,
the tree should now be moved during the MCMC.
%If the sequence data are sufficiently informative, they will induce a relatively well-focussed posterior distribution
%over the tree.
%The uncertainty about correlation parameters
%will then be automatically integrated over this posterior distribution.
Ideally, we would like to move both the toplogy and the divergence times.
Mixing over tree topologies under a Brownian model is relatively challenging, however
(it works, but it requires rather long MCMC runs).
For that reason, in the following, we will mix over divergence times only,
under the constraint of a fixed tree topology.
The features of the model that would need to be modified in order to also mix over topologies
will nevertheless be indicated. You may want try them after the workshop.

\subsection{Programming the model in RevBayes}

Implementing this joint model in RevBayes is just a matter of
adding the following features to the model defined in the previous section
(after duplicating the script):
\begin{itemize}
\item
instead of having a fixed tree, we should now define a \cl{random} tree. We could use a birth death prior, whose speciation and extinction rates are themselves endowed with some diffuse exponential prior:
\\
\cl{
speciation $\sim$ dnExp(0.1)
\\
extinction $\sim$ dnExp(0.1)
\\
sampling\_fraction := 0.01  \, \, \,    \# 40 out of the $\sim$4000 placental mammals
\\
psi $\sim$ dnBDP(lambda=speciation, mu=extinction, rho=sampling\_fraction, rootAge=1.0, nTaxa=nTaxa, names=names)
}
\item
we still want to work on a fixed, pre-specified, tree topology (thus, the birth-death prior will be used here only for averaging over uncertainty about divergence times):
\\
\cl{
treeArray <- readTrees("data/chronoplac40.tree")
\\
fixedTree <- treeArray[1]
\\
psi.setValue(fixedTree)
}
\item
create a substitution model, just like what you probably did in previous sessions. In a first step, you can use a simple GTR model, without any rate variation, neither among sites nor among branches.
\item
load the sequence data matrix specified in \cl{data/plac40\_4fold.nex} and condition (or clamp) the substitution model to this dataset.
\item
in the moves section, you should add moves for divergence times:
\\
\cl{
moves[index] <- mvSubtreeScale(psi, weight=5.0)
\\
index <- index + 1
\\
moves[index] <- mvNodeTimeSlideUniform(psi, weight=10.0)
\\
index <- index + 1
}
\item
you would add topology moves here (again, only in a second step):
\\
\cl{
moves[index] <- mvNNI(psi, weight=5.0)
\\
index <- index + 1
\\
moves[index] <- mvFNPR(psi, weight=5.0)
\\
index <- index + 1
}
\item
finally, you should add moves for the parameters of the substitution model.
\end{itemize}
Note that, here, we do not have included any fossil information: we are merely doing \emph{relative} dating. We will see at the end of this tutorial how fossil information can be integrated.

Write this model and make sure that it runs when you give it to \cl{RevBayes}. Once this is the case, don't spend too much time analyzing the results and quickly turn to the model introduced in the next section.

\section{Autocorrelated relaxed molecular clock}

In the previous model, no consideration was given to the problem of rate variation among lineages --
we bluntly used a strict clock. This is of course problematic, in particular at the phylogenetic scale considered here (placental mammals), where we know that there is substantial rate variation. In addition, we know that substitution rates across branches are \emph{auto-correlated} in the present case: typically, entire orders, such as rodents, are fast evolving, whereas other orders like Cetartiodactyla are slowly evolving. In other words, nearby lineages along the phylogeny tend to be characterized by similar substitution rates.

You have perhaps already seen an autocorrelated relaxed clock model in the molecular dating session (ACLN). You could easily recruit it in the present context (a good exercise to try after the workshop: modify the model suggested in the previous section so as to replace the strict clock by the ACLN model).

Here, however, we will derive the autocorrelated clock in a slightly different way. This derivation will be less straightforward, but more useful for what we want to do next.
Specifically, we will first model the logarithm of the instant substitution rate as a Brownian motion, just like we did for body mass in section \ref{univariate}. Then, we will exponentiate this Brownian process and take branch-specific averages, which we will finally plug into the substitution model as the \cl{branchRates} argument.

\subsection{Programming the model in RevBayes}

Compared to the model described in the last section, you should:
\begin{itemize}
\item
delete the \cl{clockRate} variable
\item
based on what you have done with body mass in section \ref{univariate}, you should be able to create a univariate Brownian process, which you could call \cl{lograte}
\item
you can then exponentiate and average this Brownian process over branches using \cl{expBranchTree}:
\\
\cl{branchrates := expBranchTree(tree=psi, process=lograte)}
\item
plug these rates into the substModel object, as the branchRates parameter vector.
\item
condition the model on the sequence and trait data and run the program.
\end{itemize}
Again, write this model by duplicating and adapting the last script that you have written. Make sure that the model runs when given to \cl{RevBayes}, before turning to the next model now introduced.

\section{Rates, dates and traits}

We have just seen that the logarithm of the substitution rate can be seen as a quantitative trait. But then, this raises one further obvious question: why considering the substitution rate and the quantitative traits as separate Brownian motions? Why not instead considering them as a joint multivariate Brownian process? Doing so would have one major advantage: the correlated evolution of rates and traits will be automatically estimated, as a by-product of the model.

To do so, we just need to define a multivariate Brownian process of dimension 4.
By convention, we will consider that the first dimension of this process
corresponds to the log of the substitution rate,
while the other 3 dimensions of the process (2 to 4) will map to the quantitative traits defined by the data matrix
\citep{Lartillot:2011p55}.

\subsection{Programming the model in RevBayes}

You now have all the tools to implement this model entirely by yourself, except for one little detail: you now need to exponentiate one specific component of a multivariate process (as opposed to exponentiating a univariate process, as we did in the previous section). Thus, assuming that \cl{X} is your 4-dimensional process, you need to tell the \cl{expBranchTree} function that you want to exponentiate the first component of the process (with the \cl{traitIndex=1} option):
\\
\cl{branchrates := expBranchTree(tree=psi, process=x, traitIndex=1)}
\\
Also, be careful with the mapping of the quantitative traits: you need to map trait $i$ to entry $i+1$ of the Brownian process:
\\
\cl{
for (i in 1:nTraits)    \{
        X.clampAt(contData,i+1,i)
\}
}
\\



\subsection{Exercises}

\begin{itemize}
\item
write the model and run it on the placental example
\item
investigate the correlation between substitution rate and life-history traits
\item
multiple regression: controlling for body mass, do you still get some support for a correlation between longevity and substitution rate variation?
\item
conversely, controlling for longevity, do you get supported correlations of the substitution rate and body mass (or with age at sexual maturity?)
\item
compare the credible interval obtained here for the body mass of the last common ancestor of placentals with what was obtained in the very first model (section \ref{univariate}).
\end{itemize}

\section{A comparative analysis of variation in GC content}

Apart from the overall substitution rate, any other aspect of the substitution process (transition-transversion ratio, dN/dS, equilbirium frequencies, etc) could in principle display variation among lineages. These various aspects of the substitution  process could therefore be modeled exactly like the substitution rate, i.e. as Brownian processes -- or as components of a multivariate Brownian process.
In this section, we will focus on compositional variation, and more particularly variation in equilibirium GC content between species.
%, or better, as components of a single large multivariate Brownian process that would combine together substitution parameters and quantitative traits such as body mass.
%In some sense, we will integrate together non-homogeneous models of sequence evolution and trait evoluiton, essentially by formalizing non-homogeneous models of sequence evolution as a particular application of the comparative method

We first start with a simple T92 model of sequence evolution:
\begin{eqnarray*}
Q &=& 
\left( \begin{array}{r|rrrrr}
&A&C&G&T\\
\hline
A&- &  \frac{\gamma}{2}  & \kappa \, \frac{\gamma}{2} &  \frac{1 - \gamma}{2} \\
\\
C& \frac{1 - \gamma}{2} & - & \frac{\gamma}{2} & \kappa \, \frac{1 - \gamma}{2}  \\
\\
G&\kappa \, \frac{1 - \gamma}{2}  &  \frac{\gamma}{2}  & - & \frac{1 - \gamma}{2}  \\
\\
T& \frac{1 - \gamma}{2} & \kappa \, \frac{\gamma}{2}  &  \frac{\gamma}{2}  & -
\end{array} \right)
\end{eqnarray*}
The model has two parameters: the transition-transversion rate $\kappa$ and the equilbrium GC content $\gamma$. In the following, we will assume that $\kappa$ is constant across the tree (although unknown, and thus endowed with a diffuse prior). In contrast, $\gamma$ will be allowed to vary among lineages, jointly with the overall substitution rate.
Technically, since $\gamma$ is strictly between 0 and 1, its log-it transform $\ln \frac{\gamma}{1 - \gamma}$ will range over the entire real line. Therefore, we could propose that the log-it transform of $\gamma$ evolves according to a Brownian motion.

Putting everything together, we will therefore propose a multivariate Brownian motion $X(t)$, of dimension $K+2$, where $K$ is the number of quantitative traits, and such that:
\begin{eqnarray*}
X_1(t) &=& \ln r(t)
\\
X_2(t) &=& \ln \frac{\Gamma(t)}{1 - \Gamma(t)}
\\
k=1..K, \quad X_{k+2}(t) &=& \ln C_k(t)
\end{eqnarray*}
where $r(t)$ is the instant substitution rate and $\gamma(t)$ the instant equilibrium GC composition
and $C_k(t)$ is the $k$th. quantitative trait.
Equivalently, we may re-write this as follows:
\begin{eqnarray*}
r(t) &=& e^{X_1(t)}
\\
\gamma(t) &=& \frac{e^{X_2(t)}}{1 + e^{X_2(t)}}
\\
\ldots
\end{eqnarray*}
In other words, the instant rate of substitution $r(t)$ is the exponential of the first component $X_1(t)$ of the Brownian process (as above), while the instant equilbirium GC $\gamma(t)$ is the \emph{hyperbolic tangent} of the second component $X_2(t)$ of the Brownian process.

There is a slight complication here: in a non-homogeneous model, independently of the rate matrices across branches, we also need to specify the nucleotide frequencies from which the sequence at the root of the tree is sampled. We will call this frequency vector $\pi$, and we will put a Dirichlet prior on $\pi$.

This model has been described in \cite{Lartillot:OUn7WLs9}.

\subsection*{Programming the model in RevBayes}

Assuming that \cl{X} is the multivariate Brownian process:
\begin{itemize}
\item
as above, define the branch rates as the exponential of the first component:
\\
\cl{branchrates := expBranchTree(tree=psi, process=X, traitIndex=1)}
\item
define the branch equilibrium GC as the hyperbolic tangent of the second component:
\\
\cl{branchGC := tanhBranchTree(tree=psi, process=X, traitIndex=2)}
\item
for $k=1..K$, map trait $k$ onto entry $k+2$ of $X$:
\\
\cl{
for (k in 1:nTraits)    \{
        X.clampAt(contData,k+2,k)
\}
}
\item
define the transition-transversion ratio; usually, this ratio is of the order of 1-10, so we will use an exponential prior of mean 10:
\\
\cl{tstv $\sim$ dnExp(0.1)}
\item
define a vector of branch-specific T92 substitution matrices:
\\
\cl{branchMatrices := t92GCBranchTree(tree=psi,branchGC=branchGC,tstv=tstv)}
\item
create a Dirichlet-distributed vector of equilbirium frequencies over nucleotides:
\\
\cl{
bf <- v(1,1,1,1)
\\
pi $\sim$ dnDirichlet(bf)
}
\item
finally, create the substitution model:
\\
\cl{
seq $\sim$ dnPhyloCTMC(tree=psi, Q=branchMatrices, rootFrequencies=pi,
\\
branchRates=branchrates, nSites=nSites, type="DNA")
}
\end{itemize}

\subsection*{Exercises}

\begin{itemize}
\item
program the model in RevBayes
\item
run the model on the placental dataset
\item
investigate the correlation between GC and body mass
\item
how do you explain these correlations?
\item
run the model on the archaeal rRNA dataset \cl{archaea.nex}, using temperature as the trait. In that case, no phylogeny is provided, so you may try to run the model without any constraint on the topology.
\item
assess the correlation between GC and temperature
\item
how much of the variation in GC is explained by temperature?
\item
what could be the underlying biological cause?
\end{itemize}


\section{Towards integrative macro-evolution modeling}

The modeling approach proposed above is just one example of the integration of multiple domains of macroevolutionary studies that could be done with RevBayes.
In the following, we outline some possible extensions or variations, based on the integrative modeling philosophy.

\subsection{Using fossil data}

Fossils have much to say about several aspects of the models and questions we have considered thus far.
They represent a valuable source of information about divergence times but also about ancestral traits.
In particular, fossil calibrations could be used in the context of each of the models that have been considered in sections 3 to 6, thus allowing us to do not just relative, but absolute, dating. In principle, most of the approaches that you have seen during the dating session of the workshop could be adapted to the present situation. It is just a matter of gathering the relevant information about mammalian fossils.

More ambitiously, the \emph{total evidence dating} method \citep{Ronquist:2012ea} could be extended so as to now include, not just discrete morphological characters, but also quantitative traits, for both extant and extinct taxa. Morphological characters would be modeled using discrete $M_k$ models, while quantitative traits would be described by multivariate Brownian processes, just as in the previous sections.

\subsection{Beyond Brownian models}

Throughout this tutorial, we have exclusively considered undirected Brownian models.
However, many other models could be used,
and this,
both for quantitative traits and for substitution rates or substitution parameters.
Right now, there are at least two other models available in RevBayes:
the Brownian model with systematic trend and the Ornstein-Uhlenbeck process.

One possible application of the Brownian model with trend would be to test for the existence of a systematic trend in increasing body size (i.e. Cope's rule) during animal, vertebrate or mammalian evolution \citep{Alroy:1998p270}. Note, however, that systematic trends cannot be estimated using only extant taxa (at least using purely anagenetic processes of evolution, such as considered here): the model would not be identifiable.
If we have fossil data, on the other hand, we can estimate a trend:
the model will then essentially rely on the average-mass-through-time distribution across the entire geological range.

Technically, to model body size evolution with drift, we would just need to:
\begin{itemize}
\item
define a drift parameter, with a diffuse prior centered on 0:
\\
\cl{
copestrend $\sim$ dnNorm(0,10)
}
\item
create a (univariate) Brownian motion with drift:
\\
\cl{logmass $\sim$ dnBrownian(psi,sigma,drift=copestrend)}
\item
move the trend parameter during the MCMC, using a regular sliding move:
\\
\cl{moves[index] <- mvSlide(copestrend, delta=2.0, tune=true, weight=3.0)
\\
index <- index + 1}
\end{itemize}
After running the model, the posterior distribution on Cope's trend parameter can be visualized and quantified, and the empirical support in favor of Cope's rule can be assessed by estimating the posterior probability that this trend parameter is positive.

